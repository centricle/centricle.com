---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Payment â€“ Kevin Smith">
  <script is:inline slot="head" src="https://js.stripe.com/v3/"></script>
  <section class="flex-1 flex items-center pt-24 py-16">
    <div class="max-w-lg mx-auto px-6 w-full">
      <div class="card overflow-hidden">
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 text-center border-b border-slate-700 -m-6 mb-6">
          <h1 class="text-3xl font-bold text-slate-100 mb-2">Complete Payment</h1>
          <p class="text-slate-400">Secure payment processing</p>
        </div>

        <div class="space-y-6">
          <div>
            <label for="payment-element" class="block text-sm font-medium text-slate-400 mb-2">Card Information</label>
            <div id="payment-element" class="transition-all duration-300">
              <!-- Stripe Elements will create form elements here -->
            </div>
            <div id="card-errors" role="alert" class="text-red-500 text-sm mt-2 min-h-5 hidden empty:hidden"></div>
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-slate-400 mb-2">Email</label>
            <input
              type="email"
              id="email"
              placeholder="you@example.com"
              class="form-input"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="amount" class="block text-sm font-medium text-slate-400 mb-2">Amount ($)</label>
              <input
                type="number"
                id="amount"
                min="1"
                step="0.01"
                placeholder="500.00"
                class="form-input"
              />
            </div>
            <div>
              <label for="invoice" class="block text-sm font-medium text-slate-400 mb-2">Invoice #</label>
              <input
                type="text"
                id="invoice"
                placeholder="INV-001"
                class="form-input"
              />
            </div>
          </div>

          <button type="button" id="submit-button" class="btn btn-primary w-full">
            <span id="button-text">Pay Now</span>
            <div id="spinner" class="animate-spin ml-2 h-4 w-4 border-2 border-slate-900 border-t-transparent rounded-full" style="display: none;"></div>
          </button>
        </div>

        <div class="text-center text-xs text-slate-400 mt-6">
          Powered by Stripe
        </div>
      </div>
    </div>
  </section>

  <script is:inline>
    // Stripe PUBLISHABLE key - intentionally client-side (test mode)
    // This is NOT a secret key. Publishable keys are designed to be embedded in client code.
    const stripe = Stripe('pk_test_51ReRbD2n3msnFGGQi9SVVWxXSKFfW8WWyrMAq948YjH6KdpTyX25vbj2hZUVLo7q5cS0dSuaYBKxlYyIZ8OGOlui00LTkInoYP');
    const elements = stripe.elements({
      mode: 'payment',
      currency: 'usd',
      amount: 50000, // Default to $500.00 (in cents)
      appearance: {
        theme: 'night',
        variables: {
          colorPrimary: '#f97316',
          colorBackground: '#16161f',
          colorText: '#ffffff',
          colorDanger: '#ef4444',
          fontFamily: 'system-ui, sans-serif',
          borderRadius: '6px',
        }
      }
    });

    // Create payment element
    const paymentElement = elements.create('payment', {
      layout: 'tabs',
      fields: {
        billingDetails: 'never'
      }
    });

    // Mount payment element
    paymentElement.mount('#payment-element');

    // Handle real-time validation errors from the payment Element
    paymentElement.on('change', ({error}) => {
      const displayError = document.getElementById('card-errors');
      if (error) {
        displayError.textContent = error.message;
      } else {
        displayError.textContent = '';
      }
    });

    // Handle form submission
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');

    submitButton.addEventListener('click', async () => {
      const cardErrors = document.getElementById('card-errors');

      // Clear any previous errors
      cardErrors.textContent = '';

      // Disable submit button and show loading
      submitButton.disabled = true;
      buttonText.textContent = 'Processing...';
      spinner.style.display = 'inline-block';

      const email = document.getElementById('email').value;
      const amount = document.getElementById('amount').value;
      const invoice = document.getElementById('invoice').value;

      try {
        // Create payment intent on your backend
        const response = await fetch('/.netlify/functions/create-payment-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            amount: Math.round(parseFloat(amount) * 100), // Convert to cents
            currency: 'usd',
            receipt_email: email,
            invoice_number: invoice,
          }),
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const { client_secret } = await response.json();

        // Confirm payment with Stripe
        const result = await stripe.confirmPayment({
          elements,
          clientSecret: client_secret,
          confirmParams: {
            return_url: window.location.href,
            receipt_email: email,
          },
          redirect: 'if_required'
        });

        if (result.error) {
          // Show error to customer
          cardErrors.textContent = result.error.message;
        } else {
          // Payment succeeded
          alert('Payment successful! Thank you for your purchase.');
          // Reset form
          document.getElementById('email').value = '';
          document.getElementById('amount').value = '';
          document.getElementById('invoice').value = '';
          paymentElement.clear();
        }
      } catch (error) {
        console.error('Error:', error);
        cardErrors.textContent = 'An error occurred. Please try again.';
      }

      // Re-enable submit button and hide loading
      submitButton.disabled = false;
      buttonText.textContent = 'Pay Now';
      spinner.style.display = 'none';
    });
  </script>
</BaseLayout>
